setwd("~/R/MPN")
rm(list=ls(all=TRUE))

install.packages("rjags")
install.packages("coda")
install.packages("R2jags")
install.packages("hdi")
install.packages("loo")

library(R2jags)
library(loo)

dat <- read.csv("allva.csv", fill = FALSE, header = TRUE) 
m1.dat<-list(c=dat$pilf,v=dat$mass,subj=dat$fid,temp=dat$temp,sal=dat$sal)

# Fitting MPN data to lognormal-binomial 
cat(
  "model{
  for (i in 1:1796) {
  c[i] ~ dbin(p[i],3)
  p[i] <- 1-exp(-lambda[i]*v[i])
  lambda[i] ~ dlnorm(mu[i],tau_all)
  mu[i] <- b0[subj[i]]+b1*temp[i]+b2*sal[i]
  zlog.like[i] <- -log(sum(dbin(c[i],p[i],3)))
  }
  for (s in 1:284) {
  b0[s] ~ dnorm(mu_b0,tau_b0)
  }
  mu_b0 ~ dnorm(0,0.1)
  tau_b0 ~ dgamma(0.1,0.1)
  tau_all ~ dgamma(0.1,0.1)
  b1 ~ dnorm(0,0.1)
  b2 ~ dnorm(0,0.1)
  }",
  file="m1.jag"
)

# Initial params
m1.inits <- list(list("b0"=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                             0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                             0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                             0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                             0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                             0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                      "tau_all"=0.1,"mu_b0"=0,"tau_b0"=1,"b1"=1,"b2"=0),
                 list("b0"=c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),
                      "tau_all"=0.01,"mu_b0"=0,"tau_b0"=1,"b1"=1,"b2"=0),
                 list("b0"=c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),
                      "tau_all"=0.1,"mu_b0"=0,"tau_b0"=0.11,"b1"=1,"b2"=0))

parameters <- c("zlog.like")

m1 <- jags(data = m1.dat,
           inits = m1.inits,
           parameters.to.save = parameters,
           model.file = "m1.jag",
           n.chains = 3,
           n.iter = 4000,
           n.burnin = 1000,
           n.thin = 3)  

# Quantify WAIC
model.loglikelihood <- m1$BUGSoutput$sims.list$zlog.like
ln.waic <- waic(model.loglikelihood)
out1 <- ln.waic$waic
out2 <- ln.waic$p_waic 